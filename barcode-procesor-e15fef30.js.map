{"version":3,"file":"barcode-procesor-e15fef30.js","sources":["../src/utils/barcode-procesor.js"],"sourcesContent":["const videoOptions = {\n  width: 500,\n  height: 500,\n  facingMode: \"environment\",\n};\n\nclass Barcoder {\n  /**\n   * \n   * @param {Node} video \n   * @param {Node} canvas \n   * @param {String} type - jsQR | quirc | builtin\n   */\n  constructor(video, canvas, options) {\n    const { type, onSuccess } = options;\n  \n    this.video = video;\n    this.canvas = canvas;\n    this.running = false;\n    this.requestId = null;\n    this.decoderType = type;\n\n    // worker is running\n    this.running = false;\n    // initial value worker\n    this.worker = null;\n    this.decode = this.decode.bind(this)\n    \n    this.stopDecoding = false;\n\n    this.onSuccess = onSuccess;\n  }\n\n  async init(){\n    if(this.worker){\n      // already initialize\n      return;\n    }\n    this.video.srcObject = await navigator.mediaDevices.getUserMedia({video: videoOptions, audio: false});\n    this.video.play();\n\n    const videoTrack = this.video.srcObject.getVideoTracks()[0];\n    const { height, width } = videoTrack.getSettings();\n\n    // setting canvas width and height\n    this.canvas.width = width;\n    this.canvas.height = height;\n\n    this.context = this.canvas.getContext('2d');\n    await this.initWorker();\n\n    // kick off\n    this.requestTick();\n  }\n\n  async initWorker(){\n    this.worker = await import('comlink').then(Comlink => {\n      if(this.decoderType === 'quirc'){\n        return Comlink.wrap(\n          new Worker(new URL('../workers/barcode-quirc.js', import.meta.url))\n        )\n      } else if(this.decoderType === 'jsqr'){\n        return Comlink.wrap(\n          new Worker(new URL('../workers/barcode-jsqr.js', import.meta.url))\n        )\n      }\n    });\n    await this.worker.init();\n  }\n\n  requestTick(){\n    if(!this.running && !this.stopDecoding) {\n      requestAnimationFrame(this.decode);\n    }\n    this.running = true;\n  }\n\n  async decode(){\n    try {\n      const { width, height } = this.canvas;\n      // draw the current video frame to canvas\n      this.context.drawImage(this.video, 0, 0);\n      // get the image data (rgba 4 channel)\n      const imageData = this.context.getImageData(0, 0, width, height);\n      // wait for image to be translated in worker\n      await this.worker.translate(imageData);\n      // get the result\n      const code = await this.worker.code;\n\n      // if cannot be translated\n      // kick requestAnimationFrame again\n      if(!code){\n        this.running = false;\n        this.requestTick();\n      } else {\n        console.log('decoded qr value:', code);\n        // do something with the code\n        if(this.onSuccess){\n          this.onSuccess(code);\n        }\n      }\n    } catch (error) {\n      console.log('SOMETHING WENT WRONG', error.message);\n      return;\n    }\n  }\n\n  destroy(){\n    if(this.requestId){\n      cancelAnimationFrame(this.requestId);\n    }\n    this.stopDecoding = true;\n  }\n}\n\nexport default Barcoder;"],"names":["videoOptions","width","height","facingMode","[object Object]","video","canvas","options","type","onSuccess","this","running","requestId","decoderType","worker","decode","bind","stopDecoding","srcObject","navigator","mediaDevices","getUserMedia","audio","play","videoTrack","getVideoTracks","getSettings","context","getContext","initWorker","requestTick","require","then","Comlink","wrap","Worker","init","requestAnimationFrame","drawImage","imageData","getImageData","translate","code","console","log","error","message","cancelAnimationFrame"],"mappings":"oEAAA,MAAMA,EAAe,CACnBC,MAAO,IACPC,OAAQ,IACRC,WAAY,yBAGd,MAOEC,YAAYC,EAAOC,EAAQC,GACzB,MAAMC,KAAEA,EAAIC,UAAEA,GAAcF,EAE5BG,KAAKL,MAAQA,EACbK,KAAKJ,OAASA,EACdI,KAAKC,SAAU,EACfD,KAAKE,UAAY,KACjBF,KAAKG,YAAcL,EAGnBE,KAAKC,SAAU,EAEfD,KAAKI,OAAS,KACdJ,KAAKK,OAASL,KAAKK,OAAOC,KAAKN,MAE/BA,KAAKO,cAAe,EAEpBP,KAAKD,UAAYA,EAGnBL,aACE,GAAGM,KAAKI,OAEN,OAEFJ,KAAKL,MAAMa,gBAAkBC,UAAUC,aAAaC,aAAa,CAAChB,MAAOL,EAAcsB,OAAO,IAC9FZ,KAAKL,MAAMkB,OAEX,MAAMC,EAAad,KAAKL,MAAMa,UAAUO,iBAAiB,IACnDvB,OAAEA,EAAMD,MAAEA,GAAUuB,EAAWE,cAGrChB,KAAKJ,OAAOL,MAAQA,EACpBS,KAAKJ,OAAOJ,OAASA,EAErBQ,KAAKiB,QAAUjB,KAAKJ,OAAOsB,WAAW,YAChClB,KAAKmB,aAGXnB,KAAKoB,cAGP1B,mBACEM,KAAKI,aAAeiB,EAAO,sBAAWC,MAAKC,GACjB,UAArBvB,KAAKG,YACCoB,EAAQC,KACb,IAAIC,OAAO,6CAEgB,SAArBzB,KAAKG,YACNoB,EAAQC,KACb,IAAIC,OAAO,iDAFR,UAMHzB,KAAKI,OAAOsB,OAGpBhC,cACMM,KAAKC,SAAYD,KAAKO,cACxBoB,sBAAsB3B,KAAKK,QAE7BL,KAAKC,SAAU,EAGjBP,eACE,IACE,MAAMH,MAAEA,EAAKC,OAAEA,GAAWQ,KAAKJ,OAE/BI,KAAKiB,QAAQW,UAAU5B,KAAKL,MAAO,EAAG,GAEtC,MAAMkC,EAAY7B,KAAKiB,QAAQa,aAAa,EAAG,EAAGvC,EAAOC,SAEnDQ,KAAKI,OAAO2B,UAAUF,GAE5B,MAAMG,QAAahC,KAAKI,OAAO4B,KAI3BA,GAIFC,QAAQC,IAAI,oBAAqBF,GAE9BhC,KAAKD,WACNC,KAAKD,UAAUiC,KANjBhC,KAAKC,SAAU,EACfD,KAAKoB,eAQP,MAAOe,GAEP,YADAF,QAAQC,IAAI,uBAAwBC,EAAMC,UAK9C1C,UACKM,KAAKE,WACNmC,qBAAqBrC,KAAKE,WAE5BF,KAAKO,cAAe"}